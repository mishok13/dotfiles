---
- name: Provision OSX utilities and applications
  hosts: localhost
  become: false
  vars:
    brew_cask_packages:
      - docker
      - font-cascadia-code
      - font-cascadia-code-pl
      - font-cascadia-mono
      - font-cascadia-mono-pl
      - font-fira-code
      - font-hack-nerd-font
      - font-inconsolata-lgc-nerd-font
      - emacs-mac
      - firefox
      - font-meslo-lg-nerd-font
      - google-chrome
      - google-drive
      - iterm2
      - mactex
      - signal
      - slack
      - spotify
      - telegram
      - todoist
      # - virtualbox
      - vlc
    brew_packages:
      - rancher-cli
      - openjdk
      - awscli
      - cabextract
      - cairo
      - coreutils
      - cowsay
      - dbus
      - dive
      - docbook
      - docbook-xsl
      - double-conversion
      - eksctl
      - exa
      - fb303
      - fbthrift
      - fd
      - fizz
      - flux
      - fluxctl
      - fmt
      - folly
      - fontconfig
      - freetype
      - fribidi
      - git
      - go
      - helm
      - htop
      - httpie
      - hunspell
      - ispell
      - jq
      - k3d
      - k9s
      - kubectx
      - kubernetes-cli
      - kubescape
      - kubeseal
#      - logitech-g-hub
      - markdown
      - mycli
      - mysql-client
      - nmap
      - nvm
      - pgcli
      - pipenv
      - podman
      - poetry
      - postgresql
      - pre-commit
      - pyenv
      - pyright
      - qemu
      - qt
      - qt@5
      - readline
      - ripgrep
      - rpm
      - rustup-init
      - shared-mime-info
      - skaffold
      - sqlite
      - stern
      - tfenv
      - tmux
      - trivy
      - yq
      - zola
      - zsh
      - zsh-completions
  tasks:
    - name: Add homebrew taps
      community.general.homebrew_tap:
        name: railwaycat/emacsmacport,homebrew/cask-fonts,homebrew/cask-drivers
        state: present
      tags:
        - bootstrap
        - packages
    - name: Install Homebrew packages
      homebrew:
        name: '{{ brew_packages }}'
        state: present
      tags:
        - bootstrap
        - packages
    - name: Install Cask packages
      homebrew_cask:
        name: '{{ item }}'
        state: present
      with_items: '{{ brew_cask_packages }}'
      tags:
        - packages
        - bootstrap
    - name: Update all packages
      homebrew:
        update_homebrew: yes
        upgrade_all: yes
      tags:
        - packages

    - name: Setup directory structure
      file:
        path: "{{ item }}"
        state: directory
      with_items:
        - "{{ lookup('env','HOME') }}/nonwork"
        - "{{ lookup('env','HOME') }}/work"
        - "{{ lookup('env','HOME') }}/.nvm"
        - "{{ lookup('env','HOME') }}/Library/Application Support/iTerm2/DynamicProfiles"

    - name: Check if .emacs.d exists
      stat: path="{{ lookup('env','HOME') }}/.emacs.d"
      register: emacsdir
      tags:
        - emacs
    - name: Check out Emacs config
      git:
        repo: 'git@github.com:mishok13/emacsen.git'
        dest: "{{ lookup('env','HOME') }}/nonwork/emacsen"
      tags:
        - emacs
    - name: Link .emacs.d to Emacs config
      file: path="{{ lookup('env','HOME') }}/.emacs.d"
            src="{{ lookup('env','HOME') }}/nonwork/emacsen"
            state=link
      when: emacsdir.stat.islnk is undefined or not emacsdir.stat.islnk
      tags:
        - emacs

    - name: Download Oh My Zsh installer
      get_url:
        url: https://raw.githubusercontent.com/robbyrussell/oh-my-zsh/master/tools/install.sh
        dest: /tmp/zsh.install.sh
        force: no
      register: zsh_installer
      tags:
        - download
        - zsh
    - name: Remove existing omz installation
      file:
        path: "{{ lookup('env','HOME') }}/.oh-my-zsh"
        state: absent
      tags:
        - zsh
    - name: Install omz
      command: "/bin/sh {{ zsh_installer.dest }}"
      tags:
        - zsh
    - name: Check out dotfiles
      git:
        repo: 'git@github.com:mishok13/dotfiles.git'
        dest: "{{ lookup('env','HOME') }}/nonwork/dotfiles"
      tags:
        - zsh
      ignore_errors: yes
    - name: Link .zshrc to dotfiles
      file:
        path: "{{ lookup('env','HOME') }}/.zshrc"
        src: "{{ lookup('env','HOME') }}/nonwork/dotfiles/.zshrc"
        state: link
        force: yes
      tags:
        - zsh
    - name: Install powerlevel10k
      git:
        repo: https://github.com/romkatv/powerlevel10k.git
        dest: "{{ lookup('env','HOME') }}/.oh-my-zsh/custom/themes/powerlevel10k"
        depth: 1
      tags:
        - zsh

    - name: Configure git
      file:
        path: "{{ lookup('env','HOME') }}/.gitconfig"
        src: "{{ lookup('env','HOME') }}/nonwork/dotfiles/gitconfig"
        state: link
        force: yes
      tags:
        - git

    - name: Configure iterm2 profiles
      copy:
        src: ../iterm.profile.json
        dest: "{{ lookup('env','HOME') }}/Library/Application Support/iTerm2/DynamicProfiles/"
      tags:
        - iterm
    - name: Download iterm2 shell integration
      get_url:
        url: https://iterm2.com/shell_integration/zsh
        dest: "{{ lookup('env','HOME') }}/.iterm2_shell_integration.zsh"
      tags:
        - iterm


    - name: Install rustup components
      command: rustup component add rls

    - name: Setup automatic daily Homebrew package updates
      cron:
        name: "homebrew upgrade"
        minute: "5"
        hour: "12"
        job: "/opt/homebrew/bin/brew update >/dev/null 2>&1"
      tags:
        - cron
    - name: Setup automatic daily Homebrew Cask package updates
      cron:
        name: "homebrew cask upgrade"
        minute: "25"
        hour: "12"
        job: "/opt/homebrew/bin/brew upgrade >/dev/null 2>&1"
      tags:
        - cron
    - name: Setup automatic Rust toolchain upgrades
      cron:
        name: "Update Rust toolchain"
        minute: "12"
        hour: "06"
        job: "{{ lookup('env','HOME') }}/.cargo/bin/rustup update >/dev/null 2>&1"
      tags:
        - cron
